name: Dev to Staging CI/CD

# PIPELINE APPROACH: Stricter Deployment with Security Gates
# This pipeline enforces production-ready standards for staging:
# 1. MANDATORY security scanning - fails on ANY vulnerabilities (CRITICAL/HIGH)
# 2. Gets the current working task definition from ECS
# 3. Updates ONLY the container image tag (preserves all other config)
# 4. Validates no other changes occurred
# 5. Deploys the minimal update with enhanced health checks
#
# Key Differences from Dev Pipeline:
# - Zero tolerance for CRITICAL/HIGH vulnerabilities
# - Manual approval gates (future enhancement)
# - Extended health check validation
# - Automated smoke tests (future enhancement)
# - Rollback on ANY failure

on:
  # This is a reusable workflow that can be called from other workflows
  workflow_call:
    # Input parameters passed from the calling workflow
    inputs:
      pr_title:
        required: true
        type: string
      pr_author:
        required: true
        type: string
      pr_url:
        required: true
        type: string
      target_branch:
        required: true
        type: string
      commit_sha:
        required: true
        type: string
      enable_ecs_deploy:
        required: false
        type: boolean
        default: true
      force_full_build:
        required: false
        type: boolean
        default: false
    # Required secrets for AWS authentication, Docker registry, and notifications
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      SLACK_WEBHOOK_URL:
        required: false
      PERSONAL_ACCESS_TOKEN:
        required: true
      BACKEND_REPO_NAME:
        required: true
      ARN_APP_SECRETS_JWT:
        required: true
      ARN_APP_SECRETS_OAUTH_GOOGLE:
        required: true
      ARN_APP_SECRETS_MAIL:
        required: true
      ARN_APP_SECRETS_MQ:
        required: true
      ARN_APP_SECRETS_REDIS:
        required: false
      ARN_APP_SECRETS_MONGO_ANALYTICS:
        required: true
      ARN_APP_SECRETS_MONGO_GAMIFICATION:
        required: true
      ARN_APP_SECRETS_MONGO_NOTIFICATION:
        required: true
      ARN_APP_SECRETS_POSTGRES_SCHEMAS:
        required: false

env:
  AWS_REGION: eu-west-1
  ECR_REGISTRY: 962496666337.dkr.ecr.eu-west-1.amazonaws.com
  ECR_REPOSITORY_PREFIX: sdt/staging
  ENVIRONMENT: staging

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest

    outputs:
      services_json: ${{ steps.compute.outputs.services_json }}
      business_services_json: ${{ steps.compute.outputs.business_services_json }}
      infra_any: ${{ steps.compute.outputs.infra_any }}
      infra_csv: ${{ steps.compute.outputs.infra_csv }}

    steps:
      - name: Checkout backend repository (full history)
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.BACKEND_REPO_NAME }}
          ref: ${{ inputs.commit_sha }}
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Compute changed services matrix
        id: compute
        shell: bash
        run: |
          set -euo pipefail

          # Define services mapping - ALL MICROSERVICES
          # Infrastructure Services (3)
          NAMES=(
            config-server discovery-server api-gateway
            analytics-service bff-service feedback-service gamification-service
            notification-service payment-service practice-service task-service user-service
          )
          PATHS=(
            skilltracker-infra/config-server
            skilltracker-infra/discovery-server
            skilltracker-infra/api-gateway
            skilltracker-services/analytics-service
            skilltracker-services/bff-service
            skilltracker-services/feedback-service
            skilltracker-services/gamification-service
            skilltracker-services/notification-service
            skilltracker-services/payment-service
            skilltracker-services/practice-service
            skilltracker-services/task-service
            skilltracker-services/user-service
          )
          PORTS=(8081 8082 8080 8086 8083 8090 8088 8091 8087 8089 8085 8084)

          # If manual override is enabled, output all services and exit
          if [ "${{ inputs.force_full_build }}" = "true" ]; then
            echo "force_full_build enabled: selecting ALL services"
            SERVICES_JSON='[]'
            BUSINESS_JSON='[]'
            INFRA_CSV="config-server,discovery-server,api-gateway"
            for i in "${!NAMES[@]}"; do
              name="${NAMES[$i]}"; path="${PATHS[$i]}"; port="${PORTS[$i]}"
              obj=$(jq -n --arg n "$name" --arg p "$path" --argjson port "$port" '{name:$n, path:$p, port:$port}')
              SERVICES_JSON=$(jq -c --argjson o "$obj" '. + [$o]' <<<"$SERVICES_JSON")
              case "$path" in
                skilltracker-infra/*) : ;;
                *) BUSINESS_JSON=$(jq -c --argjson o "$obj" '. + [$o]' <<<"$BUSINESS_JSON");;
              esac
            done
            echo "services_json<<EOF" >> "$GITHUB_OUTPUT"
            echo "$SERVICES_JSON" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"

            echo "business_services_json<<EOF" >> "$GITHUB_OUTPUT"
            echo "$BUSINESS_JSON" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"

            echo "infra_any=true" >> "$GITHUB_OUTPUT"
            echo "infra_csv=$INFRA_CSV" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          COMMIT="${{ inputs.commit_sha }}"
          PARENT="${COMMIT}^1"
          # Fallback if parent is missing (e.g., not a merge commit)
          if ! git cat-file -e "$PARENT" 2>/dev/null; then
            PARENT="${COMMIT}^"
          fi

          echo "Comparing $PARENT..$COMMIT"
          CHANGED=$(git diff --name-only "$PARENT" "$COMMIT" || true)
          printf '%s\n' "$CHANGED"

          SERVICES_JSON='[]'
          BUSINESS_JSON='[]'
          INFRA_CSV=""

          for i in "${!NAMES[@]}"; do
            name="${NAMES[$i]}"; path="${PATHS[$i]}"; port="${PORTS[$i]}"
            if printf '%s\n' "$CHANGED" | grep -qE "^${path}/"; then
              obj=$(jq -n --arg n "$name" --arg p "$path" --argjson port "$port" '{name:$n, path:$p, port:$port}')
              SERVICES_JSON=$(jq -c --argjson o "$obj" '. + [$o]' <<<"$SERVICES_JSON")
              case "$path" in
                skilltracker-infra/*)
                  if [ -z "$INFRA_CSV" ]; then INFRA_CSV="$name"; else INFRA_CSV="$INFRA_CSV,$name"; fi
                  ;;
                *)
                  BUSINESS_JSON=$(jq -c --argjson o "$obj" '. + [$o]' <<<"$BUSINESS_JSON")
                  ;;
              esac
            fi
          done

          INFRA_ANY=false
          if [ -n "$INFRA_CSV" ]; then INFRA_ANY=true; fi

          # Output JSON arrays properly
          echo "services_json<<EOF" >> "$GITHUB_OUTPUT"
          echo "$SERVICES_JSON" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "business_services_json<<EOF" >> "$GITHUB_OUTPUT"
          echo "$BUSINESS_JSON" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "infra_any=$INFRA_ANY" >> "$GITHUB_OUTPUT"
          echo "infra_csv=$INFRA_CSV" >> "$GITHUB_OUTPUT"

      - name: Debug changed services outputs
        run: |
          echo "services_json=${{ steps.compute.outputs.services_json }}"
          echo "business_services_json=${{ steps.compute.outputs.business_services_json }}"
          echo "infra_any=${{ steps.compute.outputs.infra_any }}"
          echo "infra_csv=${{ steps.compute.outputs.infra_csv }}"

  build-and-push:
    name: Build and Push Docker Images (Staging)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.services_json != '[]'

    strategy:
      fail-fast: true  # STRICTER: Fail entire build if any service fails
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services_json) }}

    steps:
      - name: Checkout devops repository (for slack action)
        uses: actions/checkout@v4

      - name: Checkout backend repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.BACKEND_REPO_NAME }}
          ref: ${{ inputs.commit_sha }}
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          fetch-depth: 0
          path: backend

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Install Maven (host)
        working-directory: backend
        run: |
          sudo apt-get update
          sudo apt-get install -y maven

      - name: Build shared dependencies
        working-directory: backend
        run: |
          echo "üîß Building shared dependencies first..."
          # Build skilltracker-common modules (required by services)
          if [ -d "./skilltracker-common" ]; then
            echo "üì¶ Building skilltracker-common modules..."
            mvn -q clean install -DskipTests \
              -pl skilltracker-common/common-event,skilltracker-common/common-security,skilltracker-common/common-util \
              -am

            echo "üì¶ Building inter-dependent services..."
            # Build user-service first (required by task-service)
            mvn -q clean install -DskipTests -pl skilltracker-services/user-service -am
          elif [ -f "./pom.xml" ]; then
            echo "üì¶ Building parent project..."
            mvn -q clean install -DskipTests -N
          else
            echo "‚ö†Ô∏è No shared dependencies found - proceeding with service build"
          fi

      - name: Prime Maven cache (host)
        working-directory: backend
        run: |
          echo "üì• Downloading dependencies for ${{ matrix.service.name }}..."
          mvn -q -DskipTests -f ./${{ matrix.service.path }}/pom.xml dependency:go-offline || echo "‚ö†Ô∏è Some dependencies may be missing - will resolve during build"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image for ${{ matrix.service.name }}
        working-directory: backend
        run: |
          echo "üî® Building ${{ matrix.service.name }} on port ${{ matrix.service.port }}"
          docker build \
            -f ./${{ matrix.service.path }}/Dockerfile \
            -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service.name }}:latest \
            -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service.name }}:${{ inputs.commit_sha }} \
            .

      - name: Run Trivy security scan (STRICT MODE)
        id: trivy-scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service.name }}:${{ inputs.commit_sha }}
          format: 'json'
          output: 'trivy-results-${{ matrix.service.name }}.json'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Exit with error if vulnerabilities found
          ignore-unfixed: false  # STRICTER: Report all vulnerabilities, even unfixed

      - name: Parse Trivy results and enforce zero-vulnerability policy
        id: check-vulns
        if: always()
        run: |
          if [ -f "trivy-results-${{ matrix.service.name }}.json" ]; then
            CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results-${{ matrix.service.name }}.json)
            HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results-${{ matrix.service.name }}.json)
            MEDIUM_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results-${{ matrix.service.name }}.json)

            echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
            echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
            echo "medium_count=$MEDIUM_COUNT" >> $GITHUB_OUTPUT

            echo "üîç Security Scan Results for ${{ matrix.service.name }}:"
            echo "   CRITICAL: $CRITICAL_COUNT"
            echo "   HIGH: $HIGH_COUNT"
            echo "   MEDIUM: $MEDIUM_COUNT"

            # STRICT POLICY: Fail on CRITICAL or HIGH vulnerabilities
            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
              echo "has_blocking_vulns=true" >> $GITHUB_OUTPUT
              echo "‚ùå BLOCKING VULNERABILITIES FOUND!"
              echo "::error::Security scan failed: $CRITICAL_COUNT CRITICAL, $HIGH_COUNT HIGH vulnerabilities detected"

              # Extract vulnerability details for notification
              echo "vuln_details<<EOF" >> $GITHUB_OUTPUT
              jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH") | "‚Ä¢ \(.VulnerabilityID): \(.PkgName) - \(.Title)"' trivy-results-${{ matrix.service.name }}.json | head -10 >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT

              exit 1  # Fail the job
            else
              echo "has_blocking_vulns=false" >> $GITHUB_OUTPUT
              echo "‚úÖ No CRITICAL or HIGH vulnerabilities"
            fi
          else
            echo "has_blocking_vulns=false" >> $GITHUB_OUTPUT
            echo "critical_count=0" >> $GITHUB_OUTPUT
            echo "high_count=0" >> $GITHUB_OUTPUT
            echo "medium_count=0" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No scan results found"
          fi

      - name: Upload Trivy scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-${{ matrix.service.name }}
          path: trivy-results-${{ matrix.service.name }}.json
          retention-days: 30

      - name: Notify Slack on security vulnerabilities
        if: failure() && steps.check-vulns.outputs.has_blocking_vulns == 'true'
        uses: ./.github/actions/slack-notify
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": ":rotating_light: SECURITY GATE FAILED - Staging Deployment Blocked",
              "attachments": [
                {
                  "color": "danger",
                  "fields": [
                    { "title": "üê≥ Service", "value": "${{ matrix.service.name }}", "short": true },
                    { "title": "Environment", "value": "Staging (BLOCKED)", "short": true },
                    { "title": "üî¥ CRITICAL", "value": "${{ steps.check-vulns.outputs.critical_count }}", "short": true },
                    { "title": "üü† HIGH", "value": "${{ steps.check-vulns.outputs.high_count }}", "short": true },
                    { "title": "üü° MEDIUM", "value": "${{ steps.check-vulns.outputs.medium_count }}", "short": true },
                    { "title": "Policy", "value": "Zero tolerance for CRITICAL/HIGH vulnerabilities in staging", "short": true },
                    { "title": "üì¶ Image", "value": "${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service.name }}:${{ inputs.commit_sha }}", "short": false },
                    { "title": "Top Vulnerabilities", "value": "${{ steps.check-vulns.outputs.vuln_details }}", "short": false },
                    { "title": "PR", "value": "${{ inputs.pr_title }}", "short": false },
                    { "title": "Author", "value": "${{ inputs.pr_author }}", "short": true },
                    { "title": "‚õî Action Required", "value": "Fix ALL CRITICAL and HIGH vulnerabilities before deploying to staging. Update base images, dependencies, or apply security patches.", "short": false },
                    { "title": "üîó View Logs", "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions>", "short": true }
                  ],
                  "footer": "Trivy Container Security Scan - Staging Gate",
                  "footer_icon": "https://github.githubassets.com/favicon.ico"
                }
              ]
            }

      - name: Push Docker image to ECR
        # Only push if security scan passed
        run: |
          echo "üì§ Pushing ${{ matrix.service.name }} to ECR (Staging)"
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service.name }}:latest
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service.name }}:${{ inputs.commit_sha }}

      - name: Image digest
        run: |
          echo "‚úÖ Successfully pushed ${{ matrix.service.name }}"
          echo "üì¶ Latest: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service.name }}:latest"
          echo "üì¶ Tagged: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service.name }}:${{ inputs.commit_sha }}"

  deploy-infra:
    name: Deploy Infra Services (Staging, Ordered)
    runs-on: ubuntu-latest
    needs: [build-and-push, detect-changes]
    if: inputs.enable_ecs_deploy && needs.detect-changes.outputs.infra_any == 'true'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy infra services sequentially (minimal updates)
        run: |
          set -euo pipefail

          deploy_one_minimal() {
            SERVICE_NAME="$1"
            echo "=== Deploying $SERVICE_NAME to Staging (Image-Only Update) ==="

            # Get currently deployed (working) task definition
            CURRENT_TASK_ARN=$(aws ecs describe-services \
              --cluster sdt-staging-cluster \
              --services sdt-staging-${SERVICE_NAME} \
              --query 'services[0].taskDefinition' \
              --output text || true)

            if [ -z "$CURRENT_TASK_ARN" ] || [ "$CURRENT_TASK_ARN" = "None" ]; then
              echo "‚ùå Service sdt-staging-${SERVICE_NAME} not found or has no taskDefinition. Skipping."
              return 0
            fi

            echo "Using working task definition: $CURRENT_TASK_ARN"

            # Get the full working task definition
            WORKING_TASK_DEF=$(aws ecs describe-task-definition \
              --task-definition "$CURRENT_TASK_ARN" \
              --query 'taskDefinition' \
              --output json)

            # Store current image for comparison
            CURRENT_IMAGE=$(echo "$WORKING_TASK_DEF" | jq -r '.containerDefinitions[0].image')
            echo "Current working image: $CURRENT_IMAGE"

            # Create new task definition with ONLY image change - USE :latest TAG
            NEW_IMAGE="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${SERVICE_NAME}:latest"
            NEW_TASK_DEF=$(echo "$WORKING_TASK_DEF" | jq \
              --arg NEW_IMAGE "$NEW_IMAGE" '
                # Update only the image
                .containerDefinitions[0].image = $NEW_IMAGE
                # Remove AWS-managed fields
                | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)
              ')

            # Validation: Ensure only image changed
            OLD_IMAGE=$(echo "$WORKING_TASK_DEF" | jq -r '.containerDefinitions[0].image')
            NEW_IMAGE_CHECK=$(echo "$NEW_TASK_DEF" | jq -r '.containerDefinitions[0].image')

            echo "‚úÖ Image update: $OLD_IMAGE ‚Üí $NEW_IMAGE_CHECK"

            # Verify no other changes occurred
            OLD_ENV_COUNT=$(echo "$WORKING_TASK_DEF" | jq '.containerDefinitions[0].environment | length')
            NEW_ENV_COUNT=$(echo "$NEW_TASK_DEF" | jq '.containerDefinitions[0].environment | length')

            if [ "$OLD_ENV_COUNT" != "$NEW_ENV_COUNT" ]; then
              echo "‚ùå Environment variables changed unexpectedly! Old: $OLD_ENV_COUNT, New: $NEW_ENV_COUNT"
              exit 1
            fi

            OLD_SECRETS_COUNT=$(echo "$WORKING_TASK_DEF" | jq '.containerDefinitions[0].secrets | length')
            NEW_SECRETS_COUNT=$(echo "$NEW_TASK_DEF" | jq '.containerDefinitions[0].secrets | length')

            if [ "$OLD_SECRETS_COUNT" != "$NEW_SECRETS_COUNT" ]; then
              echo "‚ùå Secrets changed unexpectedly! Old: $OLD_SECRETS_COUNT, New: $NEW_SECRETS_COUNT"
              exit 1
            fi

            echo "‚úÖ Configuration preserved - only image updated"

            # Register new task definition
            echo "$NEW_TASK_DEF" | jq '.' > taskdef-${SERVICE_NAME}.json
            NEW_TASK_ARN=$(aws ecs register-task-definition \
              --cli-input-json file://taskdef-${SERVICE_NAME}.json \
              --query 'taskDefinition.taskDefinitionArn' \
              --output text)

            echo "‚úÖ Registered: $NEW_TASK_ARN"

            # Deploy with new image
            echo "üöÄ Deploying $SERVICE_NAME to staging with new image..."
            aws ecs update-service \
              --cluster sdt-staging-cluster \
              --service sdt-staging-${SERVICE_NAME} \
              --task-definition "$NEW_TASK_ARN" \
              --force-new-deployment \
              --no-cli-pager

            echo "Recent ECS service events for $SERVICE_NAME:"
            aws ecs describe-services \
              --cluster sdt-staging-cluster \
              --services sdt-staging-${SERVICE_NAME} \
              --query 'services[0].events[0:10].[createdAt,message]' \
              --output table || true

            echo "Waiting for $SERVICE_NAME to stabilize (staging has stricter requirements)..."
            aws ecs wait services-stable \
              --cluster sdt-staging-cluster \
              --services sdt-staging-${SERVICE_NAME}
            echo "‚úÖ $SERVICE_NAME is stable in staging!"
          }

          # Enforce dependency order: config -> discovery -> api-gateway
          deploy_one_minimal config-server
          deploy_one_minimal discovery-server
          deploy_one_minimal api-gateway

  deploy-business:
    name: Deploy Business Services (Staging)
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-infra, detect-changes]
    if: inputs.enable_ecs_deploy && needs.detect-changes.outputs.business_services_json != '[]' && always() && (needs.deploy-infra.result == 'success' || needs.deploy-infra.result == 'skipped')

    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.business_services_json) }}
      max-parallel: 2  # STRICTER: Fewer parallel deployments for staging

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get current working task definition
        id: get-working-taskdef
        run: |
          SERVICE_NAME="${{ matrix.service.name }}"

          # Get currently deployed (working) task definition
          CURRENT_TASK_ARN=$(aws ecs describe-services \
            --cluster sdt-staging-cluster \
            --services sdt-staging-$SERVICE_NAME \
            --query 'services[0].taskDefinition' \
            --output text)

          if [ -z "$CURRENT_TASK_ARN" ] || [ "$CURRENT_TASK_ARN" = "None" ]; then
            echo "‚ùå No current task definition found for $SERVICE_NAME in staging"
            exit 1
          fi

          echo "Using working task definition: $CURRENT_TASK_ARN"

          # Get the full task definition
          WORKING_TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition "$CURRENT_TASK_ARN" \
            --query 'taskDefinition' \
            --output json)

          # Store current image for comparison
          CURRENT_IMAGE=$(echo "$WORKING_TASK_DEF" | jq -r '.containerDefinitions[0].image')
          echo "Current working image: $CURRENT_IMAGE"

          # Store for next step
          echo "$WORKING_TASK_DEF" > current-taskdef.json
          echo "current-task-arn=$CURRENT_TASK_ARN" >> $GITHUB_OUTPUT
          echo "current-image=$CURRENT_IMAGE" >> $GITHUB_OUTPUT

      - name: Create minimal task definition update (image only)
        id: minimal-update
        run: |
          SERVICE_NAME="${{ matrix.service.name }}"
          NEW_IMAGE="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/$SERVICE_NAME:latest"

          # Read the working task definition
          WORKING_TASK_DEF=$(cat current-taskdef.json)

          # Create new task definition with ONLY image change
          NEW_TASK_DEF=$(echo "$WORKING_TASK_DEF" | jq \
            --arg NEW_IMAGE "$NEW_IMAGE" '
              # Update only the image
              .containerDefinitions[0].image = $NEW_IMAGE
              # Remove AWS-managed fields
              | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)
            ')

          # Validation: Ensure only image changed
          OLD_IMAGE=$(echo "$WORKING_TASK_DEF" | jq -r '.containerDefinitions[0].image')
          NEW_IMAGE_CHECK=$(echo "$NEW_TASK_DEF" | jq -r '.containerDefinitions[0].image')

          echo "‚úÖ Image update: $OLD_IMAGE ‚Üí $NEW_IMAGE_CHECK"

          # Verify no other changes occurred
          OLD_ENV_COUNT=$(echo "$WORKING_TASK_DEF" | jq '.containerDefinitions[0].environment | length')
          NEW_ENV_COUNT=$(echo "$NEW_TASK_DEF" | jq '.containerDefinitions[0].environment | length')

          if [ "$OLD_ENV_COUNT" != "$NEW_ENV_COUNT" ]; then
            echo "‚ùå Environment variables changed unexpectedly! Old: $OLD_ENV_COUNT, New: $NEW_ENV_COUNT"
            exit 1
          fi

          OLD_SECRETS_COUNT=$(echo "$WORKING_TASK_DEF" | jq '.containerDefinitions[0].secrets | length')
          NEW_SECRETS_COUNT=$(echo "$NEW_TASK_DEF" | jq '.containerDefinitions[0].secrets | length')

          if [ "$OLD_SECRETS_COUNT" != "$NEW_SECRETS_COUNT" ]; then
            echo "‚ùå Secrets changed unexpectedly! Old: $OLD_SECRETS_COUNT, New: $NEW_SECRETS_COUNT"
            exit 1
          fi

          echo "‚úÖ Configuration preserved - only image updated"

          # Save for registration
          echo "$NEW_TASK_DEF" | jq '.' > taskdef.json

      - name: Register and deploy minimal update
        id: deploy-update
        run: |
          SERVICE_NAME="${{ matrix.service.name }}"

          # Register new task definition
          NEW_TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://taskdef.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "‚úÖ Registered: $NEW_TASK_ARN"

          # Deploy with new image
          echo "üöÄ Deploying $SERVICE_NAME to staging with new image..."
          aws ecs update-service \
            --cluster sdt-staging-cluster \
            --service sdt-staging-$SERVICE_NAME \
            --task-definition "$NEW_TASK_ARN" \
            --force-new-deployment \
            --no-cli-pager

          echo "task-arn=$NEW_TASK_ARN" >> $GITHUB_OUTPUT

      - name: Show recent ECS service events
        run: |
          aws ecs describe-services \
            --cluster sdt-staging-cluster \
            --services sdt-staging-${{ matrix.service.name }} \
            --query 'services[0].events[0:10].[createdAt,message]' \
            --output table || true

      - name: Wait for service stability (extended timeout for staging)
        run: |
          echo "‚è≥ Waiting for service to stabilize in staging..."
          aws ecs wait services-stable \
            --cluster sdt-staging-cluster \
            --services sdt-staging-${{ matrix.service.name }}
          echo "‚úÖ Service ${{ matrix.service.name }} is stable in staging!"

  health-check:
    name: Enhanced Health Check (Staging)
    runs-on: ubuntu-latest
    needs: [deploy-infra, deploy-business, detect-changes]
    if: inputs.enable_ecs_deploy && needs.detect-changes.outputs.services_json != '[]' && always() && (needs.deploy-infra.result == 'success' || needs.deploy-infra.result == 'skipped') && (needs.deploy-business.result == 'success' || needs.deploy-business.result == 'skipped')

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check ECS service health (staging)
        run: |
          echo "üè• Checking health of changed services in staging..."
          # Ensure jq is available
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y jq
          fi

          SERVICES_JSON='${{ needs.detect-changes.outputs.services_json }}'
          # Build bash array of service names from JSON
          mapfile -t SERVICES < <(echo "$SERVICES_JSON" | jq -r '.[].name')

          if [ "${#SERVICES[@]}" -eq 0 ]; then
            echo "No services detected as changed. Skipping health check."
            exit 0
          fi

          ALL_HEALTHY=true
          for service in "${SERVICES[@]}"; do
            echo "Checking sdt-staging-$service..."
            STATUS=$(aws ecs describe-services \
              --cluster sdt-staging-cluster \
              --services sdt-staging-$service \
              --query 'services[0].{Running:runningCount,Desired:desiredCount,Status:status}' \
              --output json 2>/dev/null || echo '{}')

            RUNNING=$(echo "$STATUS" | jq -r '.Running // 0')
            DESIRED=$(echo "$STATUS" | jq -r '.Desired // 0')

            if [ "$RUNNING" -eq "$DESIRED" ] && [ "$RUNNING" -gt 0 ]; then
              echo "‚úÖ $service: $RUNNING/$DESIRED tasks running"
            else
              echo "‚ùå $service: $RUNNING/$DESIRED tasks running"
              ALL_HEALTHY=false
            fi
          done

          if [ "$ALL_HEALTHY" = false ]; then
            echo "‚ö†Ô∏è Some services are not healthy in staging!"
            exit 1
          fi

          echo "‚úÖ All checked services are healthy in staging!"

      - name: Get ALB endpoint
        id: get-alb
        run: |
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names sdt-staging-alb \
            --query 'LoadBalancers[0].DNSName' \
            --output text)
          echo "alb-dns=$ALB_DNS" >> $GITHUB_OUTPUT
          echo "üìç Staging ALB Endpoint: http://$ALB_DNS"

  notify-security-gate-failure:
    name: Notify Security Gate Failure
    runs-on: ubuntu-latest
    needs: [build-and-push, detect-changes]
    if: failure() && needs.build-and-push.result == 'failure'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send security gate failure notification
        uses: ./.github/actions/slack-notify
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": ":no_entry: STAGING DEPLOYMENT BLOCKED - Security Gate Failed",
              "attachments": [
                {
                  "color": "danger",
                  "fields": [
                    { "title": "‚ùå Failure Stage", "value": "Security Scanning (Trivy)", "short": true },
                    { "title": "Environment", "value": "Staging (BLOCKED)", "short": true },
                    { "title": "PR Title", "value": "${{ inputs.pr_title }}", "short": false },
                    { "title": "Author", "value": "${{ inputs.pr_author }}", "short": true },
                    { "title": "Commit", "value": "<${{ inputs.pr_url }}|View PR>", "short": true },
                    { "title": "‚õî Policy", "value": "Zero tolerance for CRITICAL/HIGH vulnerabilities in staging environment", "short": false },
                    { "title": "Action Required", "value": "1. Review Trivy scan results\n2. Fix all CRITICAL and HIGH vulnerabilities\n3. Update base images and dependencies\n4. Re-run deployment after fixes", "short": false },
                    { "title": "View Logs", "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions>", "short": true }
                  ],
                  "footer": "GitHub Actions - Security Gate Failure",
                  "footer_icon": "https://github.githubassets.com/favicon.ico"
                }
              ]
            }

  notify-deploy-failure:
    name: Notify Deployment Failure
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-infra, deploy-business, detect-changes]
    if: failure() && (needs.deploy-infra.result == 'failure' || needs.deploy-business.result == 'failure')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send deployment failure notification
        uses: ./.github/actions/slack-notify
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": ":warning: Deployment Failed - Backend to Staging",
              "attachments": [
                {
                  "color": "danger",
                  "fields": [
                    { "title": "‚ùå Failure Stage", "value": "ECS Deployment", "short": true },
                    { "title": "Environment", "value": "Staging", "short": true },
                    { "title": "PR Title", "value": "${{ inputs.pr_title }}", "short": false },
                    { "title": "Author", "value": "${{ inputs.pr_author }}", "short": true },
                    { "title": "Commit", "value": "<${{ inputs.pr_url }}|View PR>", "short": true },
                    { "title": "‚ö†Ô∏è Action Required", "value": "Check ECS service events, task logs, and deployment status in AWS Console for staging cluster.", "short": false },
                    { "title": "üîó View Details", "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions Logs>", "short": true }
                  ],
                  "footer": "GitHub Actions - Deployment Failure",
                  "footer_icon": "https://github.githubassets.com/favicon.ico"
                }
              ]
            }

  notify-health-failure:
    name: Notify Health Check Failure
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-infra, deploy-business, health-check]
    if: failure() && needs.health-check.result == 'failure'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send health check failure notification
        uses: ./.github/actions/slack-notify
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": ":rotating_light: Health Check Failed - Staging Deployment",
              "attachments": [
                {
                  "color": "danger",
                  "fields": [
                    { "title": "‚ùå Failure Stage", "value": "Health Check", "short": true },
                    { "title": "Environment", "value": "Staging", "short": true },
                    { "title": "PR Title", "value": "${{ inputs.pr_title }}", "short": false },
                    { "title": "Author", "value": "${{ inputs.pr_author }}", "short": true },
                    { "title": "Commit", "value": "<${{ inputs.pr_url }}|View PR>", "short": true },
                    { "title": "‚ö†Ô∏è Action Required", "value": "Health check failed - automatic rollback initiated for staging environment", "short": false },
                    { "title": "üîó View Details", "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Check logs for service status and events>", "short": false }
                  ],
                  "footer": "GitHub Actions - Health Check Failure",
                  "footer_icon": "https://github.githubassets.com/favicon.ico"
                }
              ]
            }

  notify-slack:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-infra, deploy-business, health-check]
    if: always() && needs.build-and-push.result == 'success' && (needs.deploy-infra.result == 'success' || needs.deploy-infra.result == 'skipped') && (needs.deploy-business.result == 'success' || needs.deploy-business.result == 'skipped') && needs.health-check.result == 'success'

    steps:
      - name: Checkout repository (required for local actions)
        uses: actions/checkout@v4

      - name: Send success notification
        uses: ./.github/actions/slack-notify
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": ":white_check_mark: Deployment Successful - Backend to Staging",
              "attachments": [
                {
                  "color": "good",
                  "fields": [
                    { "title": "‚úÖ Status", "value": "All stages completed successfully", "short": true },
                    { "title": "Environment", "value": "Staging", "short": true },
                    { "title": "PR Title", "value": "${{ inputs.pr_title }}", "short": false },
                    { "title": "Author", "value": "${{ inputs.pr_author }}", "short": true },
                    { "title": "Commit", "value": "<${{ inputs.pr_url }}|View PR>", "short": true },
                    { "title": "Security", "value": "‚úÖ Passed strict security scan (Zero CRITICAL/HIGH)", "short": true },
                    { "title": "Build Result", "value": "‚úÖ ${{ needs.build-and-push.result }}", "short": true },
                    { "title": "Deploy Results", "value": "‚úÖ infra: ${{ needs.deploy-infra.result }}, business: ${{ needs.deploy-business.result }}", "short": true },
                    { "title": "Health Check", "value": "‚úÖ ${{ needs.health-check.result }}", "short": true },
                    { "title": "View Details", "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions>", "short": true }
                  ],
                  "footer": "GitHub Actions - Deployment Success (Staging)",
                  "footer_icon": "https://github.githubassets.com/favicon.ico"
                }
              ]
            }

  summary:
    name: Deployment Summary (Staging)
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-push, deploy-infra, deploy-business, health-check]
    if: always()

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Generate detailed summary
        run: |
          set -euo pipefail

          echo "## üöÄ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ===================================
          # DEPLOYMENT METADATA
          # ===================================
          echo "### üìã Deployment Metadata" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | üîí Staging (Production-Ready) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Security Policy** | Zero tolerance for CRITICAL/HIGH vulnerabilities |" >> $GITHUB_STEP_SUMMARY
          echo "| **PR Title** | ${{ inputs.pr_title }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Author** | ${{ inputs.pr_author }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target Branch** | \`${{ inputs.target_branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | \`${{ inputs.commit_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Run** | [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ===================================
          # PIPELINE STAGE RESULTS
          # ===================================
          echo "### üîÑ Pipeline Stage Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Build stage
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            BUILD_ICON="‚úÖ"
          else
            BUILD_ICON="‚ùå"
          fi
          echo "| **Build & Security Scan** | $BUILD_ICON \`${{ needs.build-and-push.result }}\` |" >> $GITHUB_STEP_SUMMARY

          # Deploy Infra stage
          if [ "${{ needs.deploy-infra.result }}" == "success" ]; then
            DEPLOY_INFRA_ICON="‚úÖ"
          elif [ "${{ needs.deploy-infra.result }}" == "skipped" ]; then
            DEPLOY_INFRA_ICON="‚è≠Ô∏è"
          else
            DEPLOY_INFRA_ICON="‚ùå"
          fi
          echo "| **Deploy Infrastructure** | $DEPLOY_INFRA_ICON \`${{ needs.deploy-infra.result }}\` |" >> $GITHUB_STEP_SUMMARY

          # Deploy Business stage
          if [ "${{ needs.deploy-business.result }}" == "success" ]; then
            DEPLOY_BIZ_ICON="‚úÖ"
          elif [ "${{ needs.deploy-business.result }}" == "skipped" ]; then
            DEPLOY_BIZ_ICON="‚è≠Ô∏è"
          else
            DEPLOY_BIZ_ICON="‚ùå"
          fi
          echo "| **Deploy Business Logic** | $DEPLOY_BIZ_ICON \`${{ needs.deploy-business.result }}\` |" >> $GITHUB_STEP_SUMMARY

          # Health Check stage
          if [ "${{ needs.health-check.result }}" == "success" ]; then
            HEALTH_ICON="‚úÖ"
          else
            HEALTH_ICON="‚ùå"
          fi
          echo "| **Health Check** | $HEALTH_ICON \`${{ needs.health-check.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ===================================
          # SERVICES CHANGED & DEPLOYED
          # ===================================
          echo "### üéØ Services Changed & Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get actual changed services from detect-changes output
          SERVICES_JSON='${{ needs.detect-changes.outputs.services_json }}'
          CHANGED_COUNT=$(echo "$SERVICES_JSON" | jq 'length')

          if [ "$CHANGED_COUNT" -eq 0 ]; then
            echo "‚è≠Ô∏è **No services changed** - Full build was forced or this is a manual deployment." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "**$CHANGED_COUNT service(s) changed and deployed:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Service | Port | Type | Build | Deploy | Health |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|------|------|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY

            # Parse services and create array
            SERVICES=($(echo "$SERVICES_JSON" | jq -r '.[].name'))

            for service in "${SERVICES[@]}"; do
              # Get service metadata
              PORT=$(echo "$SERVICES_JSON" | jq -r ".[] | select(.name==\"$service\") | .port")
              SERVICE_TYPE=$(echo "$SERVICES_JSON" | jq -r ".[] | select(.name==\"$service\") | .type")

              # Convert type to readable format
              if [ "$SERVICE_TYPE" == "infra" ]; then
                SERVICE_TYPE="üèóÔ∏è Infrastructure"
              else
                SERVICE_TYPE="üíº Business"
              fi

              # Determine build status
              if [ "${{ needs.build-and-push.result }}" == "success" ]; then
                BUILD_ICON="‚úÖ"
              else
                BUILD_ICON="‚ùå"
              fi

              # Determine deploy status based on service type
              if [ "$SERVICE_TYPE" == "üèóÔ∏è Infrastructure" ]; then
                if [ "${{ needs.deploy-infra.result }}" == "success" ]; then
                  DEPLOY_ICON="‚úÖ"
                else
                  DEPLOY_ICON="‚ùå"
                fi
              else
                if [ "${{ needs.deploy-business.result }}" == "success" ]; then
                  DEPLOY_ICON="‚úÖ"
                else
                  DEPLOY_ICON="‚ùå"
                fi
              fi

              # Query actual ECS health status
              HEALTH_STATUS=$(aws ecs describe-services \
                --cluster sdt-staging-cluster \
                --services sdt-staging-$service \
                --query 'services[0].{running:runningCount,desired:desiredCount}' \
                --output json 2>/dev/null || echo '{"running":0,"desired":0}')

              RUNNING=$(echo "$HEALTH_STATUS" | jq -r '.running // 0')
              DESIRED=$(echo "$HEALTH_STATUS" | jq -r '.desired // 0')

              # Determine health icon and text
              if [ "$RUNNING" -eq "$DESIRED" ] && [ "$RUNNING" -gt 0 ]; then
                HEALTH_ICON="‚úÖ"
                HEALTH_TEXT="$RUNNING/$DESIRED"
              elif [ "$RUNNING" -gt 0 ] && [ "$RUNNING" -lt "$DESIRED" ]; then
                HEALTH_ICON="‚ö†Ô∏è"
                HEALTH_TEXT="$RUNNING/$DESIRED"
              else
                HEALTH_ICON="‚ùå"
                HEALTH_TEXT="$RUNNING/$DESIRED"
              fi

              echo "| **$service** | \`$PORT\` | $SERVICE_TYPE | $BUILD_ICON | $DEPLOY_ICON | $HEALTH_ICON \`$HEALTH_TEXT\` |" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # ===================================
          # DETAILED HEALTH STATUS
          # ===================================
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary><b>üìä Detailed Health Status (Click to expand)</b></summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ECS Service Health Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CHANGED_COUNT" -eq 0 ]; then
            echo "_No services were changed in this deployment._" >> $GITHUB_STEP_SUMMARY
          else
            for service in "${SERVICES[@]}"; do
              echo "**Service: \`sdt-staging-$service\`**" >> $GITHUB_STEP_SUMMARY

              # Get full service details
              SERVICE_DETAILS=$(aws ecs describe-services \
                --cluster sdt-staging-cluster \
                --services sdt-staging-$service \
                --query 'services[0]' \
                --output json 2>/dev/null || echo '{}')

              RUNNING=$(echo "$SERVICE_DETAILS" | jq -r '.runningCount // 0')
              DESIRED=$(echo "$SERVICE_DETAILS" | jq -r '.desiredCount // 0')
              PENDING=$(echo "$SERVICE_DETAILS" | jq -r '.pendingCount // 0')
              STATUS=$(echo "$SERVICE_DETAILS" | jq -r '.status // "UNKNOWN"')

              echo "- **Status:** \`$STATUS\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Running Tasks:** $RUNNING" >> $GITHUB_STEP_SUMMARY
              echo "- **Desired Tasks:** $DESIRED" >> $GITHUB_STEP_SUMMARY
              echo "- **Pending Tasks:** $PENDING" >> $GITHUB_STEP_SUMMARY

              # Get task definition
              TASK_DEF=$(echo "$SERVICE_DETAILS" | jq -r '.taskDefinition // "N/A"')
              echo "- **Task Definition:** \`$TASK_DEF\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            done
          fi

          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ===================================
          # SECURITY SCAN RESULTS
          # ===================================
          echo "### üîí Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "‚úÖ **All services passed strict security scanning**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Policy:** Zero tolerance for CRITICAL and HIGH vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "- **Scanner:** Trivy (aquasecurity)" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** No blocking vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            echo "- **Unfixed CVEs:** Reported (not ignored)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Security scan failed - Deployment blocked**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more services have CRITICAL or HIGH severity vulnerabilities." >> $GITHUB_STEP_SUMMARY
            echo "Please review the build logs and Trivy reports to address security issues." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # ===================================
          # CONTAINER IMAGES
          # ===================================
          echo "### üê≥ Container Images Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CHANGED_COUNT" -eq 0 ]; then
            echo "_No new images were built._" >> $GITHUB_STEP_SUMMARY
          else
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "Registry: 962496666337.dkr.ecr.eu-west-1.amazonaws.com/sdt/staging/" >> $GITHUB_STEP_SUMMARY
            echo "Image Tag: ${{ inputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Images:" >> $GITHUB_STEP_SUMMARY
            for service in "${SERVICES[@]}"; do
              echo "  - sdt/staging/$service:${{ inputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
            done
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # ===================================
          # INFRASTRUCTURE DETAILS
          # ===================================
          echo "### üèóÔ∏è Infrastructure Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **ECS Cluster** | \`sdt-staging-cluster\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **AWS Region** | \`eu-west-1\` (Ireland) |" >> $GITHUB_STEP_SUMMARY
          echo "| **ECR Registry** | \`962496666337.dkr.ecr.eu-west-1.amazonaws.com\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | Staging (Pre-Production) |" >> $GITHUB_STEP_SUMMARY

          # Get ALB endpoint (if available)
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --query 'LoadBalancers[?contains(LoadBalancerName, `staging`)].DNSName | [0]' \
            --output text 2>/dev/null || echo "N/A")

          if [ "$ALB_DNS" != "N/A" ] && [ -n "$ALB_DNS" ]; then
            echo "| **Load Balancer** | [${ALB_DNS}](http://${ALB_DNS}) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Load Balancer** | Not available |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # ===================================
          # FINAL STATUS
          # ===================================
          if [ "${{ needs.health-check.result }}" == "success" ] && [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚úÖ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All services are healthy and running in the **Staging** environment." >> $GITHUB_STEP_SUMMARY
            echo "All security gates passed with zero CRITICAL/HIGH vulnerabilities detected." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Quick Links:**" >> $GITHUB_STEP_SUMMARY
            echo "- [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
            echo "- [View Pull Request](${{ inputs.pr_url }})" >> $GITHUB_STEP_SUMMARY
            echo "- [AWS ECS Console](https://eu-west-1.console.aws.amazon.com/ecs/v2/clusters/sdt-staging-cluster/services)" >> $GITHUB_STEP_SUMMARY
          else
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚ö†Ô∏è Deployment Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some pipeline stages did not complete successfully. Please review:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Build Status:** \`${{ needs.build-and-push.result }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Deploy Infra Status:** \`${{ needs.deploy-infra.result }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Deploy Business Status:** \`${{ needs.deploy-business.result }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Health Check Status:** \`${{ needs.health-check.result }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
            echo "2. Check service health in the [ECS console](https://eu-west-1.console.aws.amazon.com/ecs/v2/clusters/sdt-staging-cluster/services)" >> $GITHUB_STEP_SUMMARY
            echo "3. Review Trivy security scan reports if build failed" >> $GITHUB_STEP_SUMMARY
            echo "4. If health checks failed, automatic rollback may have been triggered" >> $GITHUB_STEP_SUMMARY
          fi

  rollback-on-failure:
    name: Rollback on Failure (Staging)
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-infra, deploy-business, health-check]
    if: needs.health-check.result == 'failure'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Roll back infra services (if changed)
        if: needs.detect-changes.outputs.infra_any == 'true'
        shell: bash
        run: |
          set -euo pipefail
          IFS=',' read -r -a INFRA <<< "${{ needs.detect-changes.outputs.infra_csv }}"
          for name in "${INFRA[@]}"; do
            echo "Rolling back $name in staging..."
            # Get previous task definition ARN (second most recent)
            PREV=$(aws ecs list-task-definitions \
              --family-prefix sdt-staging-$name \
              --sort DESC \
              --max-items 2 \
              --query 'taskDefinitionArns[-1]' \
              --output text)
            if [ -z "$PREV" ] || [ "$PREV" = "None" ]; then
              echo "No previous task definition found for $name; skipping"
              continue
            fi
            aws ecs update-service \
              --cluster sdt-staging-cluster \
              --service sdt-staging-$name \
              --task-definition "$PREV" \
              --force-new-deployment \
              --no-cli-pager
            aws ecs wait services-stable --cluster sdt-staging-cluster --services sdt-staging-$name
            echo "‚úÖ Rolled back $name to $PREV"
          done

      - name: Roll back business services (if changed)
        shell: bash
        run: |
          set -euo pipefail
          SERVICES_JSON='${{ needs.detect-changes.outputs.business_services_json }}'
          COUNT=$(jq 'length' <<<"$SERVICES_JSON")
          if [ "$COUNT" -eq 0 ]; then
            echo "No business services changed; nothing to roll back."
            exit 0
          fi
          for name in $(jq -r '.[].name' <<<"$SERVICES_JSON"); do
            echo "Rolling back $name in staging..."
            PREV=$(aws ecs list-task-definitions \
              --family-prefix sdt-staging-$name \
              --sort DESC \
              --max-items 2 \
              --query 'taskDefinitionArns[-1]' \
              --output text)
            if [ -z "$PREV" ] || [ "$PREV" = "None" ]; then
              echo "No previous task definition found for $name; skipping"
              continue
            fi
            aws ecs update-service \
              --cluster sdt-staging-cluster \
              --service sdt-staging-$name \
              --task-definition "$PREV" \
              --force-new-deployment \
              --no-cli-pager
            aws ecs wait services-stable --cluster sdt-staging-cluster --services sdt-staging-$name
            echo "‚úÖ Rolled back $name to $PREV"
          done

      - name: Send rollback notification
        uses: ./.github/actions/slack-notify
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": ":arrows_counterclockwise: Automatic Rollback Completed - Staging Environment",
              "attachments": [
                {
                  "color": "warning",
                  "fields": [
                    { "title": "üîÑ Action Taken", "value": "Automatic Rollback (Staging)", "short": true },
                    { "title": "Environment", "value": "Staging", "short": true },
                    { "title": "PR Title", "value": "${{ inputs.pr_title }}", "short": false },
                    { "title": "Author", "value": "${{ inputs.pr_author }}", "short": true },
                    { "title": "Commit", "value": "<${{ inputs.pr_url }}|View PR>", "short": true },
                    { "title": "Reason", "value": "Health check failed after deployment to staging", "short": false },
                    { "title": "Services Rolled Back", "value": "All changed services reverted to previous working versions", "short": false },
                    { "title": "Status", "value": "‚úÖ Staging environment restored to stable state", "short": false },
                    { "title": "Next Steps", "value": "Review deployment logs, fix issues, and retry deployment to staging", "short": false },
                    { "title": "View Logs", "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions>", "short": true }
                  ],
                  "footer": "GitHub Actions - Automatic Rollback (Staging)",
                  "footer_icon": "https://github.githubassets.com/favicon.ico"
                }
              ]
            }
