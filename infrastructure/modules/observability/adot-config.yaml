# AWS Distro for OpenTelemetry (ADOT) Collector Configuration
# This configuration scrapes Spring Boot Actuator metrics and forwards to Prometheus

receivers:
  # Prometheus receiver to scrape metrics from application
  prometheus:
    config:
      scrape_configs:
        # Scrape Spring Boot Actuator metrics
        - job_name: 'spring-boot-app'
          scrape_interval: 15s
          scrape_timeout: 10s
          metrics_path: '/actuator/prometheus'
          static_configs:
            - targets: ['localhost:8080']  # Adjust port based on service
          relabel_configs:
            - source_labels: [__address__]
              target_label: instance
            - target_label: job
              replacement: '${SERVICE_NAME}'
        
        # Scrape JVM metrics if available
        - job_name: 'jvm-metrics'
          scrape_interval: 15s
          metrics_path: '/actuator/metrics'
          static_configs:
            - targets: ['localhost:8080']
          metric_relabel_configs:
            - source_labels: [__name__]
              regex: 'jvm_.*|process_.*|system_.*'
              action: keep

  # OTLP receiver for traces (future use)
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  # Batch processor to reduce number of requests
  batch:
    timeout: 10s
    send_batch_size: 1024
  
  # Memory limiter to prevent OOM
  memory_limiter:
    check_interval: 1s
    limit_mib: 256
    spike_limit_mib: 64
  
  # Resource processor to add metadata
  resource:
    attributes:
      - key: service.name
        value: ${SERVICE_NAME}
        action: upsert
      - key: deployment.environment
        value: ${ENVIRONMENT}
        action: upsert
      - key: aws.ecs.cluster.name
        value: ${ECS_CLUSTER_NAME}
        action: upsert
      - key: aws.ecs.task.family
        value: ${ECS_TASK_FAMILY}
        action: upsert
      - key: aws.region
        value: ${AWS_REGION}
        action: upsert
  
  # Resource detection to auto-discover ECS metadata
  resourcedetection:
    detectors: [env, ecs, ec2, system]
    timeout: 5s
    override: false

exporters:
  # Prometheus Remote Write exporter
  prometheusremotewrite:
    endpoint: ${PROMETHEUS_ENDPOINT}
    tls:
      insecure: true
    resource_to_telemetry_conversion:
      enabled: true
  
  # CloudWatch exporter (optional - for hybrid monitoring)
  awscloudwatch:
    region: ${AWS_REGION}
    namespace: ${PROJECT_NAME}/${ENVIRONMENT}/Metrics
    log_group_name: /aws/ecs/${PROJECT_NAME}-${ENVIRONMENT}-adot
    log_stream_name: ${SERVICE_NAME}
  
  # Logging exporter for debugging
  logging:
    loglevel: info

extensions:
  # Health check extension
  health_check:
    endpoint: 0.0.0.0:13133
  
  # Performance profiler
  pprof:
    endpoint: 0.0.0.0:1777
  
  # zPages for diagnostics
  zpages:
    endpoint: 0.0.0.0:55679

service:
  extensions: [health_check, pprof, zpages]
  pipelines:
    # Metrics pipeline
    metrics:
      receivers: [prometheus, otlp]
      processors: [memory_limiter, resource, resourcedetection, batch]
      exporters: [prometheusremotewrite, logging]
    
    # Traces pipeline (for future use)
    traces:
      receivers: [otlp]
      processors: [memory_limiter, resource, resourcedetection, batch]
      exporters: [logging]
  
  telemetry:
    logs:
      level: info
    metrics:
      level: detailed
      address: 0.0.0.0:8888
